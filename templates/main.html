<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8"/>
        <meta title="viewport" content="width=device-width, initial-scale=1.0"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"/>
        <script defer src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"></script>
        <!-- D3.js -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>

        <link href="../static/main.css" rel="stylesheet" />
        <title>정글고리</title>
        <script>
            $(document).ready(function () {
                $('#mbtiBtn').click();
                networkGraph.createGraph();
            });
            var NETWORK_DATA = {
                "nodes": [
                    {
                        "id": "나",
                        "value": 10,
                        "group": "user",
                        "img": "https://cdn4.iconfinder.com/data/icons/seo-and-data/500/pencil-gear-128.png"
                    },
                    {
                        "id": "친구1",
                        "value": 3,
                        "group": null,
                        "img": "https://cdn4.iconfinder.com/data/icons/seo-and-data/500/pencil-gear-128.png"
                    },
                    {
                        "id": "친구2",
                        "value": 3,
                        "group": null,
                        "img": "https://cdn4.iconfinder.com/data/icons/seo-and-data/500/pencil-gear-128.png"
                    },
                    {
                        "id": "친구3",
                        "value": 4,
                        "group": null,
                        "img": "https://cdn4.iconfinder.com/data/icons/seo-and-data/500/pencil-gear-128.png"
                    },
                    {
                        "id": "친구4",
                        "value": 4,
                        "group": null,
                        "img": "https://cdn4.iconfinder.com/data/icons/seo-and-data/500/pencil-gear-128.png"
                    },
                    {
                        "id": "친구5",
                        "value": 5,
                        "group": null,
                        "img": "https://cdn4.iconfinder.com/data/icons/seo-and-data/500/pencil-gear-128.png"
                    },
                    {
                        "id": "친구6",
                        "value": 6,
                        "group": null,
                        "img": "https://cdn4.iconfinder.com/data/icons/seo-and-data/500/pencil-gear-128.png"
                    },
                    {
                        "id": "친구7",
                        "value": 4,
                        "group": null,
                        "img": "https://cdn4.iconfinder.com/data/icons/seo-and-data/500/pencil-gear-128.png"
                    }
                ],
                "links": [
                    {
                        "source": "나",
                        "target": "친구1",
                        "value": 1
                    },
                    {
                        "source": "나",
                        "target": "친구2",
                        "value": 1
                    },
                    {
                        "source": "나",
                        "target": "친구3",
                        "value": 1
                    },
                    {
                        "source": "나",
                        "target": "친구4",
                        "value": 4
                    },
                    {
                        "source": "나",
                        "target": "친구5",
                        "value": 1
                    },
                    {
                        "source": "나",
                        "target": "친구6",
                        "value": 2
                    },
                    {
                        "source": "나",
                        "target": "친구7",
                        "value": 3
                    }
                    ]
                };

            /*----------------------------------------------------------------------*/
            

            function changeSorter(newMode) {
                selectId = $(newMode);

                if(selectId.hasClass('active')){
                    selectId.removeClass('active')
                } else {
                    selectId.addClass('active')
                }

                selectArr = [];
                $('.accoBtn').each(function(idx, item){
                    if($(this).hasClass('active')){
                        target = $(this).attr("id");
                        selectArr.push(target);
                    }
                });
                return ;
                getAcco(selectArr);
            }

            function getAcco(arrData) {
                $.ajax({
                    type: "POST",
                    url: "/api/getAcco",
                    traditional : true,
                    data: {'arr': arrData},
                    success: function (response) {
                        if (response['result'] == 'success') {

                        } else {
                            
                        }
                    }
                });
            }
            /******** network graph ********/

            var networkGraph = {
                createGraph : function(){
                    var links = NETWORK_DATA.links.map(function(d){
                                    return Object.create(d)
                                });
                    var nodes = NETWORK_DATA.nodes.map(function(d){
                                    return Object.create(d)
                                });
                    var color = function(d){
                        var scale = d3.scaleOrdinal(d3.schemeCategory10);
                        return (scale(d.group));
                    };
                    var fillCircle = function(g){
                        if(g == "user"){
                            return "yellow";
                        }else{
                            return "skyblue";
                        }
                    };

                    var width = 500;
                    var height = 350;

                    var simulation = d3.forceSimulation(nodes)
                            .force("link", d3.forceLink(links).id( function(d){ return d.id }))
                            .force("charge", d3.forceManyBody().strength(-100))
                            .force("center", d3.forceCenter(width / 2, height / 2))
                            .force("collide",d3.forceCollide().radius( function(d){ return d.value*8}) );

                    //simulation.stop(); // stop 필요한가?


                    var svg = d3.select("#NETWORK_GRAPH")
                                .attr("viewBox", [0, 0, width, height]);
                    var gHolder = svg.append("g")
                                        .attr("class", "g-holder");
                    var link = gHolder.append("g")
                                    .attr("stroke", "#999")
                                    .attr("stroke-opacity", 0.6)
                                .selectAll("line")
                                    .data(links)
                                    .join("line")
                                        .attr("stroke-width", function(d){ return Math.sqrt(d.value*5)} );
                    var defs = svg.append('svg:defs');
                    var config = {
                        "avatar_size": 60
                    }

                    var node = gHolder.append("g")
                                .attr("class", "circle-node-holder")
                            .selectAll("g")
                                .data(nodes)
                                .enter()
                                .append("g")
                                .each(function(d){
                                    d3.select(this).append('clipPath')
                                    .attr('id','clipObj')  
                                    .append('circle')
                                    .attr('cx',config.avatar_size/2)
                                    .attr('cy',config.avatar_size/2)
                                    .attr('r',config.avatar_size/2);
                        
                                    d3.select(this)
                                    .append('image')
                                    .attr('xlink:href',d.img)
                                    .attr('width',config.avatar_size)
                                    .attr('height',config.avatar_size)
                                    .attr('transform','translate('+parseInt(-60+config.avatar_size/2)+','+parseInt(-60+config.avatar_size/2)+')')
                                    .attr('clip-path','url(#clipObj)');
                                }).call(networkGraph.drag(simulation));

                    simulation.on("tick", function(){
                        link.attr("x1", function(d){ return d.source.x; })
                            .attr("y1", function(d){ return d.source.y; })
                            .attr("x2", function(d){ return d.target.x; })
                            .attr("y2", function(d){ return d.target.y; });

                        /*node
                            .attr("cx", function(d){ return d.x; })
                            .attr("cy", function(d){ return d.y; });*/

                        //circle 노드에서 g 노드로 변경
                        node.attr("transform", function(d) { return "translate("+d.x+","+ d.y+")"; });
                    });

                    //invalidation.then(() => simulation.stop());

                    return svg.node();
                },
                drag : function(simulation){
                    function dragstarted(d) {
                        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    }

                    function dragged(d) {
                        d.fx = d3.event.x;
                        d.fy = d3.event.y;
                    }

                    function dragended(d) {
                        if (!d3.event.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    }

                    return d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended);
                }
            }
            

            /*----------------------------------------------------------------------*/
        </script>
    </head>
    <body>
        <div class="mx-auto sorter-box mt-4">
            <div class="" style="height: 85px;">
                <div class="" style="height: 50%;">
                    <a href="#" class="btn btn-primary" id="" onclick="" style="float:left">
                        정보 수정
                    </a>
                    <a href="#" class="btn btn-primary" id="" onclick="" style="float:right">
                        로그아웃
                    </a>
                </div>
                <div class="" style="height: 39%; border-top: 2px solid skyblue; border-bottom: 2px solid skyblue;">
                    <div style="width: 50%; float:left; text-align: center;">
                        <span >아이디 : {{id}}</span>
                    </div>
                    <div style="width: 50%; float:left; text-align: center;">
                        <span>이름 : {{name}}</span>
                    </div>
                </div>
            </div>
            <div class="">
                <div class="btn-group" style="width: 100%; padding-left: 1vw; padding-right: 1vw;">
                    <a href="#" class="accoBtn btn btn-primary" id="mbtiBtn" value="mbti" onclick="changeSorter(this)">
                        MBTI    
                    </a>
                    <a href="#" class="accoBtn btn btn-primary" id="locBtn" value="loc" onclick="changeSorter(this)">
                        지역
                    </a>
                    <a href="#" class="accoBtn btn btn-primary" id="schoolBtn" value="school" onclick="changeSorter(this)">
                        학교
                    </a>
                    <a href="#" class="accoBtn btn btn-primary" id="majBtn" value="major" onclick="changeSorter(this)">
                        학과
                    </a>
                    <a href="#" class="accoBtn btn btn-primary" id="genBtn" value="gender" onclick="changeSorter(this)">
                        성별
                    </a>
                    <a href="#" class="accoBtn btn btn-primary" id="smkBtn" value="smk" onclick="changeSorter(this)">
                        흡연
                    </a>
                </div>
            </div>
            <div class="">
                <span class="d-flex justify-content-end">
                    <div id="trash-mode-box">
                    </div>
                    <div class="movie-list" id="movie-box">
                        <div class="card" style="min-height: 600px;">
                            <div class="netwrok-graph">
                                <svg id="NETWORK_GRAPH">
                                    
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </body>
</html>